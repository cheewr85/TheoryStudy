# Deadlock
## 정의
시스템 자원에 대한 요청이 뒤엉킨 상태. 두 개 이상의 프로세스가 다른 프로세스가 점유하고 있는 자원을 서로 기다릴 때 무한대기에 빠지는 상황

## 데드락의 발생조건
- 상호 배제
	- 복수의 프로세스가 서로에게 필요한 자원을 보유하고 있어 서로가 작업이 끝나기를 기다리는 상태
- 점유 대기
	-  하나의 프로세스는 최소 하나의 자원을 보유하고, 다른 프로세스가 점유 중인 자원을 점유하기 위해 대기 중
- 비선점
	- 이미 할당된 자원을 강제로 빼앗을 수 없음
- 순환 대기
	- 대기 중인 프로세스의 집합이 순환 형태로 자원을 대기 중

## 데드락 해결방법
세 가지의 해결방법 : 예방, 회피, 탐지 후 회복
### 예방
- 데드락 발생조건 4가지의 발생을 방지하여 데드락을 예방함
- 자원의 상호 배제 조건 방지:프로세스가 공유 자원을 사용하도록 함
	- 동기화 문제 발생 가능
- 점유 대기 조건 방지:필요한 자원을 프로세스 실행 시 한번에 요구하여, 도중에 다른 자원을 점유하기 위해서 대기하지 않도록 함
- 비선점 조건 방지:이미 다른 프로세스에서 사용 중인 자원을 선점한 프로세스가 없을 때, 높은 우선순위의 프로세스가 선점하도록 함
- 순환 대기 조건 방지:자원이 순환 형태로 대기하지 않도록 자원 요구를 한 쪽 방향으로만 하도록 함
> 데드락 예방은 시스템의 처리량과 효율성을 저해하는 단점 
> -> 조금 덜 제한적인 방식으로 회피법 활용
### 회피
- Safe State:시스템의 프로세스가 요청하는 모든 자원을 데드락을 발생시키지 않으면서 차례로 모두에게 할당해줄 수 있는 안정 상태
	- Unsafe State일 때, 데드락 발생 가능성이 존재 (데드락이 발생하는 **조건**)
- Safe Sequence:프로세스들이 데드락을 발생시키지 않는 안전한 순서


회피 알고리즘은 시스템이 항상 **Safe state**에 있도록 자원 할당 : 은행원 알고리즘
### 은행원 알고리즘(Banker's Algorithm)
어떤 자원의 할당을 허용할지 결정하기 전에, 이미 결정된 모든 자원의 최대 가능 할당량을 통해 시뮬레이션 하여 safe state가 가능한지 검사함


시스템이 총 12개의 자원을 보유할 경우,
|Process|Max|Allocated|Need|Available|
|-|-|-|-|-|
|p0|10|5|5| |
|p1|4|2|2| |
|p2|9|2|7| |

Max : 프로세스의 최대 자원 요청량, Allocated : 프로세스에 할당된 자원의 양, Need : 아직 할당이 필요한 자원의 양

현재 할당된 자원의 합 : 5+2+2=9개

따라서 현재 Available 자원은 12-9=3개
1. 프로세스 p1은 현재 2개의 자원을 할당받았고, 2개를 추가로 필요로 한다. 이때 Available 자원이 3개이므로, 2개를 할당받는다. -> Available : 3-2=1
2. 실행이 끝난 p1이 자신에 할당되어 있던 자원 4개를 모두 반납 -> Available : 1+4=5
3. 다음으로 p0이 필요로 하는 자원을 Available 5개를 모두 활용하여 할당
4. 실행이 끝난 p0이 할당되어 있던 자원 10개 모두 반납
5. p2가 필요한 자원 7개 할당
6. 모든 프로세스 실행 완료

> 은행원 알고리즘
> 사전에 필요한 할당량을 파악하여 데드락을 회피하면서 p1 -> p0 ->p2의 순서로 프로세스를 완료함
> 최대 자원 요구량을 알아야 하고, 할당 가능한 자원수가 일정해야 하는 등의 제약 조건 존재

### 데드락 탐지 및 회복
데드락이 발생하는 것은 허용을 하되, 그로부터 적절히 회복하도록 함
- 탐지(Detection)
	- Allocation, Request, Available 등에서 시스템에 데드락이 발생했는지 확인 
	- 현재 시스템의 자원 할당 상태를 가지고 파악
	- 자원 할당 그래프 활용
- 회복(Recovery)
	프로세스가 **순환 대기**에서 벗어나도록 함
	- 프로세스를 1개 이상 중단시키기
		- 데드락에 빠진 모든 프로세스를 중단 : 계속 연산중이던 프로세스들도 모두 중단되어 이미 진행된 결과까지 폐기되는 부작용
		- 프로세스를 하나씩 중단하면서 탐지 알고리즘으로 데드락 탐지하면서 회복 : 잦은 탐지 알고리즘 호출의 부담
	- 자원 선점하기
		- 프로세스에 할당된 자원을 선점하여, 교착 상태를 해결할 때까지 다른 프로세스에 먼저 할당



